<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>2020 US Presidential Election Results Dot Density Map</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.17/esri/themes/light/main.css" />

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }

    /* Add this for the custom popup */
    #infoDiv {
      display: none;
      position: fixed;
      top: 55px;
      right: 20px;
      background-color: #fff;
      padding: 10px;
      margin: 5px;
      z-index: 99;
      font-family: "Lacuna", sans-serif;
      box-shadow: 0px 1px 2px rgba(0, 0, 0, 0.2);
    }
  </style>

  <script src="https://js.arcgis.com/4.17/"></script>

  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/renderers/DotDensityRenderer",
      "esri/widgets/Legend",
      "esri/widgets/Bookmarks",
      "esri/widgets/Expand",
      "esri/PopupTemplate",
      "esri/widgets/Popup",
      "esri/widgets/Search"
    ], function (
      WebMap,
      MapView,
      FeatureLayer,
      DotDensityRenderer,
      Legend,
      Bookmarks,
      Expand,
      PopupTemplate,
      Popup,
      Search
    ) {
      
      const map = new WebMap({
        portalItem: {
          id: "3582b744bba84668b52a16b0b6942544"
        }
      });

      const view = new MapView({
        container: "viewDiv",
        zoom: 4,
        center: [-98.554210, 37.813620],
        map: map,
        highlightOptions: {
          fillOpacity: 0,
          color: [50, 50, 50]
        },
        constraints: {
          maxScale: 35000
        }
      });

      const searchWidget = new Search({
        view: view
      });

      view.ui.add(searchWidget, {
        position: "top-right"
      });
      
      let currentPrecinctID = null;  // Initialize currentPrecinctID

      view.when().then(function () {
        // Load the feature layer
        const layer = new FeatureLayer({
          url: "https://services2.arcgis.com/VNo0ht0YPXJoI4oE/arcgis/rest/services/2020_Election_Final_Prec_Results/FeatureServer",
          minScale: 200000000,
          maxScale: 35000,
          title: "2020 US Presidential Election Dot Density Results by Voting Precinct",
          outFields: ["FID", "PCTBID_S", "G20PREDBID", "PCTTRU_S", "G20PRERTRU", "PCTOTH_S", "Total_Othe"]  // Removed Precinct_Name
        });

        map.add(layer);

        view.whenLayerView(layer).then(function (layerView) {
          // Create the dot density renderer and apply it to the layer
          const dotDensityRenderer = new DotDensityRenderer({
            dotValue: 1,
            outline: null,
            dotBlendingEnabled: true,
            referenceScale: 100000,
            legendOptions: {
              unit: "Vote(s)"
            },
            attributes: [
              {
                field: "G20PREDBID",
                color: "#00b6f1",
                label: "Biden (D)"
              },
              {
                field: "G20PRERTRU",
                color: "#f23c3f",
                label: "Trump (R)"
              }
            ]
          });

          layer.renderer = dotDensityRenderer;

          // Add the pointer and highlight logic after the layer is fully loaded
          view.on("pointer-move", eventHandler);

          let highlight;
          const infoDiv = document.getElementById('infoDiv');

          function eventHandler(event) {
            const screenPoint = {
              x: event.x,
              y: event.y
            };

            view.hitTest(screenPoint, { tolerance: 20 }).then(function(response) {
              if (response.results.length > 0) {
                const graphic = response.results[0].graphic;
                const featureID = graphic.attributes.FID;  // Use the FID attribute

                if (featureID !== currentPrecinctID) {
                  currentPrecinctID = featureID;

                  if (highlight) {
                    highlight.remove();
                    highlight = null;
                  }

                  highlight = layerView.highlight(graphic);

                  // Update the infoDiv
                  infoDiv.innerHTML = 
                    "<span style='color: black; font-size: 1.2em;'>Precinct Results</span><br><br>" +
                    "<b style='color: black;'>Biden:</b> <b style='color: dodgerblue;'>" + graphic.attributes.PCTBID_S + "</b> (" + graphic.attributes.G20PREDBID.toLocaleString() + " votes)<br>" +
                    "<b style='color: black;'>Trump:</b> <b style='color: red;'>" + graphic.attributes.PCTTRU_S + "</b> (" + graphic.attributes.G20PRERTRU.toLocaleString() + " votes)<br>" +
                    "<b style='color: black;'>Other:</b> <b style='color: dimgrey;'>" + graphic.attributes.PCTOTH_S + "</b> (" + graphic.attributes.Total_Othe.toLocaleString() + " votes)";
                  
                  // Show the infoDiv
                  infoDiv.style.display = 'block';
                }
              } else {
                if (highlight) {
                  highlight.remove();
                  highlight = null;
                }
                currentPrecinctID = null;
                
                // Hide the infoDiv
                infoDiv.style.display = 'none';
              }
            });
          }
        });
      });

      view.ui.add(
        [
          new Expand({
            view: view,
            content: new Legend({ view: view }),
            group: "top-left",
            expanded: true
          }),
          new Expand({
            view: view,
            content: new Bookmarks({ view: view }),
            group: "top-left"
          })
        ],
        "top-left"
      );
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="infoDiv"></div>  <!-- Add this for the custom popup -->
</body>
</html>
