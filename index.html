<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>2020 US Presidential Election Results Dot Density Map</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.17/esri/themes/light/main.css" />

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
  </style>

  <script src="https://js.arcgis.com/4.17/"></script>

  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/layers/FeatureLayer",
      "esri/renderers/DotDensityRenderer",
      "esri/widgets/Legend",
      "esri/widgets/Bookmarks",
      "esri/widgets/Expand",
      "esri/PopupTemplate",
      "esri/widgets/Popup"
    ], function (
      WebMap,
      MapView,
      FeatureLayer,
      DotDensityRenderer,
      Legend,
      Bookmarks,
      Expand,
      PopupTemplate,
      Popup
    ) {
      const map = new WebMap({
        portalItem: {
          id: "3582b744bba84668b52a16b0b6942544"
        }
      });

      const view = new MapView({
        container: "viewDiv",
        zoom: 4,
        center: [-98.554210, 37.813620],
        map: map,
        highlightOptions: {
          fillOpacity: 0,
          color: [50, 50, 50]
        },
        constraints: {
          maxScale: 35000
        }
      });

      view.when().then(function () {
        // Load the feature layer
        const layer = new FeatureLayer({
          url: "https://services2.arcgis.com/VNo0ht0YPXJoI4oE/arcgis/rest/services/2020_Election_Final_Prec_Results/FeatureServer",
          minScale: 200000000,
          maxScale: 35000,
          title: "2020 US Presidential Election Dot Density Results by Voting Precinct"
        });

        map.add(layer);

        const template = new PopupTemplate({
          title: "Precinct Results",
          content: [
            {
              type: "fields",
              fieldInfos: [
                {
                  fieldName: "PCTBID",
                  label: "<b>% Biden</b>",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: "G20PREDBID",
                  label: "Votes",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: "PCTTRU",
                  label: "<b>% Trump</b>",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: "G20PRERTRU",
                  label: "Votes",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: "PCTOTH",
                  label: "<b>% Other</b>",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                },
                {
                  fieldName: "Total_Othe",
                  label: "Votes",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                }
              ]
            }
          ]
        });

        layer.popupTemplate = template;

        view.whenLayerView(layer).then(function (layerView) {
          // Create the dot density renderer and apply it to the layer
          const dotDensityRenderer = new DotDensityRenderer({
            dotValue: 1,
            outline: null,
            dotBlendingEnabled: true,
            referenceScale: 100000,
            legendOptions: {
              unit: "Vote(s)"
            },
            attributes: [
              {
                field: "G20PREDBID",
                color: "#00b6f1",
                label: "Biden (D)"
              },
              {
                field: "G20PRERTRU",
                color: "#f23c3f",
                label: "Trump (R)"
              }
            ]
          });

          layer.renderer = dotDensityRenderer;

          // Add the pointer and highlight logic after the layer is fully loaded
          view.on("pointer-move", eventHandler);

          let highlight;
          view.popup = new Popup({
            dockEnabled: true,
            dockOptions: {
              position: "top-right",
              breakpoint: false
            }
          });

          function eventHandler(event) {
            const screenPoint = {
              x: event.x,
              y: event.y
            };

            view.hitTest(screenPoint).then(getGraphics);
          }

          function getGraphics(response) {
            if (response.results.length > 0) {
              const graphic = response.results[0].graphic;

              if (highlight && highlight.graphic === graphic) {
                return;
              }

              if (highlight) {
                highlight.remove();
                highlight = null;
              }

              highlight = layerView.highlight(graphic);
              view.popup.open({
                features: [graphic],
                location: event.mapPoint
              });
            } else {
              if (highlight) {
                highlight.remove();
                highlight = null;
              }
              view.popup.close();
            }
          }
        });
      });

      view.ui.add(
        [
          new Expand({
            view: view,
            content: new Legend({ view: view }),
            group: "top-left",
            expanded: true
          }),
          new Expand({
            view: view,
            content: new Bookmarks({ view: view }),
            group: "top-left"
          })
        ],
        "top-left"
      );
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
</body>
</html>
